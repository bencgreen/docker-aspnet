#!/bin/sh

set -euo pipefail


#======================================================================================================================
# Get .NET Version
#======================================================================================================================

cd /tmp
V=$(cat VERSION)
[[ -z "${V}" ]] && bcg-error "Unable to determine .NET version."


#======================================================================================================================
# Get correct installer for target platform
#======================================================================================================================

case "${TARGETPLATFORM-}" in
    "linux/amd64")
        ARCH="x64"
        ;;
    "linux/arm64")
        ARCH="arm64"
        ;;
    *)
esac

[[ -z "${ARCH-}" ]] && bcg-error "Unsupported target platform: ${TARGETPLATFORM}."


#======================================================================================================================
# Install .NET Runtime
#======================================================================================================================

RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bcg-echo "Downloading ${RUNTIME_URL}..."
wget -O dotnet.tar.gz ${RUNTIME_URL} \
    && mkdir -p /usr/share/dotnet \
    && tar -C /usr/share/dotnet -oxzf dotnet.tar.gz \
    && ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet \
    && rm dotnet.tar.gz

[[ ! -d "/usr/share/dotnet" ]] && bcg-error ".NET runtime not installed."
bcg-done


#======================================================================================================================
# Install ASP.NET Runtime
#======================================================================================================================

ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bcg-echo "Downloading ${ASPNET_URL}..."
wget -O aspnetcore.tar.gz ${ASPNET_URL} \
    && tar -ozxf aspnetcore.tar.gz -C /usr/share/dotnet ./shared/Microsoft.AspNetCore.App \
    && rm aspnetcore.tar.gz

[[ ! -d "/usr/share/dotnet/shared/Microsoft.AspNetCore.App/${V}" ]] && bcg-error "ASP.NET runtime not installed."
bcg-done
